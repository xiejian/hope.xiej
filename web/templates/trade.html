{% extends "base.html" %}
{% block content %}
<script type="text/javascript" src="{{url_for('static',filename='trade.js')}}"></script>
<h2>TRADE</h2>
{% if error %}<p class=error><strong>Error:</strong> {{ error }}{% endif %}

<div class="left">
<table id ="continfo">
</table>
<h3>order queue</h3>
<table id="oqueue">
</table>
<h3>transactions</h3>
<table id="transhis">
</table>
</div>

<div class="right">
<form action="{{ url_for('trade') }}" method=post>
    <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
    <dl>
        <dt>Buy/Sell:
        <dd><input type="radio" name="b_s" value="B" /> BUY <input type="radio" name="b_s" value="S" /> SELL
        <dt>Contract:
        <dd><select id="contract" name="contract_id">
                {% for ck in cont.keys() %}
                    <option value="{{ck}}" {% if ck == default_cid %} selected="selected" {% endif %} >{{cont[ck]['name']}}</option>
                {% endfor %}
            </select>
        <dt>Point:
        <dd><input type=text name="point" value="" />
        <dt>Lots:
        <dd><input type=number name="lots" value="" />
        <dd><input type=submit value=Trade>
    </dl>
</form>
<hr/>
<h3>Open Orders</h3>
<table>
    {% for ok in session['orders'] %}
        <tr><<td>{{ session['orders'][ok]['createtime'] }}</td><td>{{ cont[session['orders'][ok]['contract_id']]['name'] }}</td><td>{{ session['orders'][ok]['buy_sell'] }}</td>
            <td>{{ session['orders'][ok]['price'] }}</td><td>{{ session['orders'][ok]['lots'] }}</td><td>{{ session['orders'][ok]['rm_lots'] }}</td>
            <td>{{ session['orders'][ok]['price']|float*session['orders'][ok]['rm_lots']*cont[session['orders'][ok]['contract_id']]['leverage'] }}</td>
            <td><form action="{{ url_for('trade') }}" method="POST">
                <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
                <input type="hidden" name="orderid" value= "{{ok}}" />
                <input type="hidden" name="contract_id" value= "{{session['orders'][ok]['contract_id']}}" />
                <button type="submit" value="cancel"> × </button>
            </form></td></tr>
    {% endfor %}
    <tr><th>Order Time</th><th>Contract</th><th>B/S</th><th>Price</th><th>Lots</th><th>Remain_Lots</th><th>Margin</th><th>Cancel</th></tr>
</table>
<hr/>
<h3>Position</h3>
<table>
    <tr><th>Contract</th><th>B/S</th><th>Point</th><th>Lots</th><th>Cost</th><th>MarketValue</th><th>Profit/Loss</th><th>Margin</th><th>Close</th></tr>
    {% for p in session['positions'] %}
    <tr>
        <td>{{cont[p.contract_id]['name']}}</td><td>{{p.buy_sell}}</td><td>{{p.price}}</td><td>{{p.lots}}</td><td>{{p.price|float * p.lots/cont[p.contract_id]['btc_multi']}}</td>
        <td>{{cont[p.contract_id]['latestpoint']*p.lots}}</td><td>{{(cont[p.contract_id]['latestpoint']-p.price|float/cont[p.contract_id]['btc_multi'])*p.lots}}</td>
        <td>{{cont[p.contract_id]['latestpoint']*p.lots*cont[p.contract_id]['leverage']}}</td>
        <td><a href="{{ url_for('trade',c = p.contract_id) }}"> × </a></td>
    </tr>
    {% else %}
    <tr>None</tr>
    {% endfor %}
</table>
</div>
{% endblock %}