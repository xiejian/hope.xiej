{% extends "_utitle.html" %}
{% block head %}
    <script type="text/javascript" src="{{url_for('static',filename='js/account.js')}}"></script>
    <link type="text/css" href="{{url_for('static',filename='css/account.css')}}" rel="stylesheet" />
{% endblock %}


{% block content %}
<h3>Effect Fee Rate: <em>{{ (g.u['feerate']*100)|f }}%</em> × <em>{{ (g.u['returnrate']*100)|f }}% OFF</em>
    {% if g.u['s_coupon'] %} ×  <em> {{ (g.u['s_coupon']*100)|f }}% OFF</em> {% endif %}
     =  <em> {{ (g.u['feerate']*(1-g.u['returnrate'])*(1-g.u['s_coupon'])*100)|f }}% </em></h3>

<div class="navi">
<ul id="accountmenu">
    <li><a href=0>General Info</a></li>
    <li><a href=1>Account History</a></li>
    <li><a href=2>My Contracts</a></li>
    <li><a href=3>Security Info</a></li>
</ul>
</div>
<div class="grid_13 account_tab">
<h4>
    Current Fee Rate: <em>{{ (g.u['feerate']*100)|f }}%</em>
</h4>
<div class="grid_9 alpha ">
<p>Your trade fee rate is set from 0.4% to 0.07% based on your trade volume in last one month. </p>
    <p>The more you trade, the lower fee rate you get.</p>

    <table class="ginfo grid_5 push_1">
        <tr><th>My Trade Volume</th><td> {{ g.u['tradevol'] |f }}</td></tr>

    <tr><th>My Fee Rate</th><td>{{ (g.u['feerate']*100)|f }}%</td></tr></table>
</div>

<div class="grid_3 prefix_1 omega">
    <table><tr><th>Trade Volume</th><th>Fee Rate</th></tr>
        <tr{% if g.u['feerate']|float == 0.004 %} class="selected" {% endif %}><td>< 50</td><td>0.4%</td></tr>
        <tr{% if g.u['feerate']|float == 0.003 %} class="selected" {% endif %}><td>< 100</td><td>0.3%</td></tr>
        <tr{% if g.u['feerate']|float == 0.0025 %} class="selected" {% endif %}><td>< 200</td><td>0.25%</td></tr>
        <tr{% if g.u['feerate']|float == 0.002 %} class="selected" {% endif %}><td>< 400</td><td>0.2%</td></tr>
        <tr{% if g.u['feerate']|float == 0.0015 %} class="selected" {% endif %}><td>< 1k</td><td>0.15%</td></tr>
        <tr{% if g.u['feerate']|float == 0.001 %} class="selected" {% endif %}><td>< 2k</td><td>0.1%</td></tr>
        <tr{% if g.u['feerate']|float == 0.0008 %} class="selected" {% endif %}><td>< 5k</td><td>0.08%</td></tr>
        <tr{% if g.u['feerate']|float == 0.0007 %} class="selected" {% endif %}><td>>= 10k</td><td>0.07%</td></tr></table>
</div>
<div class="clear"></div>

<h4>
    This Month Fee Coupon: <em>{{ (g.u['returnrate']*100)|f }}% OFF</em>
</h4>
<div class="grid_9 alpha ">
<p>You could use fee coupon and receive a fee discount return at the end of month.</p>
    <p>Your fee coupon of this month is set from 10% to 80% based on you and your friends' trade volume in last one month.</p>
    <p> The more friends you get, the higher fee coupon you get.</p>
    <table class="ginfo grid_5 prefix_1">
        <tr><th>Num of My Friends</th><td> {{ g.u['rnum'] |f }}</td></tr>
        <tr><th>My Friends' Trade Volume</th><td> {{ g.u['rtradevol'] |f }}</td></tr>
        <tr><th>My Effective Trade Volume</th><td> {{ (g.u['tradevol'] + g.u['rtradevol'])|f }}</td></tr>
        <tr><th>Fee Return Rate</th><td>{{ (g.u['returnrate']*100)|f }}%</td></tr></table>
    <br/><a class="modalInput" rel="#invite_friend" href="#invite_friend">Invite more friends</a>

    <div class="modal" id="invite_friend">
        <h3>Invite your friends to join BTCFE</h3>
            <!--todo 发送邀请信，限制名额.-->
            <h4>As reward:</h4>
            <p>Your friend will get 6 × 10% OFF special coupon and 0.1 BTC after his first trade;</p>
            <p>You will get all this trade volume in the future.</p>
        <form action="{{ url_for('account',t='I') }}" method=post class="invite">
            <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
            <input type=email name="email" value="" size="22" required="required"/>
            <input type=submit value="Send Invite" {% if not g.u['invite'] %}disabled="disabled"{% endif %}> {{ g.u['invite'] }} left
        </form>
    </div>
</div>

<div class="grid_3 prefix_1 omega">
    <table><tr><th>Trade Volume</th><th>Coupon Rate</th></tr>
        <tr{% if g.u['returnrate']|float == 0.1 %} class="selected" {% endif %}><td>< 100</td><td>10% OFF</td></tr>
        <tr{% if g.u['returnrate'] |float== 0.2 %} class="selected" {% endif %}><td>< 400</td><td>20% OFF</td></tr>
        <tr{% if g.u['returnrate'] |float== 0.3 %} class="selected" {% endif %}><td>< 1.5k</td><td>30% OFF</td></tr>
        <tr{% if g.u['returnrate'] |float== 0.4 %} class="selected" {% endif %}><td>< 5k</td><td>40% OFF</td></tr>
        <tr{% if g.u['returnrate'] |float== 0.5 %} class="selected" {% endif %}><td>< 20k</td><td>50% OFF</td></tr>
        <tr{% if g.u['returnrate'] |float== 0.6 %} class="selected" {% endif %}><td>< 100k</td><td>60% OFF</td></tr>
        <tr{% if g.u['returnrate'] |float== 0.7 %} class="selected" {% endif %}><td>< 500k</td><td>70% OFF</td></tr>
        <tr{% if g.u['returnrate'] |float== 0.8 %} class="selected" {% endif %}><td>>= 2m</td><td>80% OFF</td></tr></table>
</div>
<div class="clear"></div>
{% if g.u['s_coupon']%}
    <h4>Special Coupon: <em> {{ (g.u['s_coupon']*100)|f }}% OFF </em></h4>
    <p>You could apply both of regular fee coupon and special coupon same time.</p>
    <table class="ginfo grid_5 push_1">
        <tr><th>Remains</th><td> {{ g.u['sc_num'] }} months</td></tr>
        <tr><th>Comment</th><td>{{ g.u['sc_comment'] }}</td></tr></table>

<div class="clear"></div>
{% endif %}

</div>

<div class="grid_13 account_tab">

<h4>Transaction History</h4>
<table>
    {% for t in g.u['trans'] %}
        {% if loop.first %}
    <tr><th>TimeStamp</th><th colspan="2">Action</th><th>Point</th><th>Lots</th><th>Fee</th><th>Pofit/Loss</th><th>BTC I/O</th><th>Comment</th></tr>
    <tr><th>{{ g.u['openbal']['balance_dt'] }}</th><th colspan="2">Opening Balance</th><th></th><th></th><th>{{ g.u['openbal']['bal_fee']|f }}</th><th>{{ g.u['openbal']['bal_pl']|f }}</th>
        <th>{{ g.u['openbal']['bal_btc']|f }}</th><th>SUM: {{ g.u['openbal']['balance']|f }}</th></tr>
        {% endif %}

    {% if t.sector == 'T' %}
        <tr><td>{{t.timestamp}}</td><td>{{t.buy_sell|f("F")}}</td><td>{{cont[t.contract_id]['name']}}</td><td>{{t.point|f}}</td>
            <td>{{t.lots}}</td><td>{{t.fee|f}}</td><td>{{t.p_l|f}}</td><td></td><td>{{t.type|f("F")}}</td></tr>
    {% elif t.sector == 'R'  %}
        <tr><td>{{t.timestamp}}</td><td colspan="2">Apply Fee Coupon</td><td></td>
            <td></td><td>{{t.fee|f}}</td><td></td><td></td><td>{{t.type|f("F")}}</td></tr>
    {% elif t.sector == 'B' %}
        <tr><td>{{t.timestamp}}</td><td colspan="2">Bitcoin Transfer</td><td></td>
            <td></td><td></td><td></td><td>{{ t.btc_transfer|f }}</td><td>{{t.type|f("F")}}</td></tr>
    {% endif %}
    {% else %}
    <tr><th>None</th></tr>
    {% endfor %}
    {% if g.u['trans'] %}
    <tr><th>{{ g.u['trans'][-1]['timestamp'] }}</th><th colspan="2">Closing Balance</th><th></th><th></th><th>{{ (g.u['trans']|sum(attribute='fee') + g.u['openbal']['bal_fee'])|f }}</th>
        <th>{{ (g.u['trans']|sum(attribute='p_l')+g.u['openbal']['bal_pl'])|f }}</th><th>{{ (g.u['trans']|sum(attribute='btc_transfer')+g.u['openbal']['bal_btc'])|f }}</th>
        <th>SUM: {{ (g.u['openbal']['balance']+g.u['trans']|sum(attribute='fee')+g.u['trans']|sum(attribute='p_l')+g.u['trans']|sum(attribute='btc_transfer'))|f }}</th></tr>
    {% endif %}
</table>

  <div class="clear"></div>
</div>

<div class="grid_13 account_tab">
    <h4>My Contracts</h4>
    <a class="modalInput" rel="#edit_cont" href="#Edit">Create My Own Contract</a><br/>
    <table>
        <tr><th>ID</th><th>Name</th><th>latestpoint</th><th>leverage</th><th>btc_multi</th><th>Open Date</th><th>Settle Date</th>
            <th>Full Name</th><th>Region</th><th>Sector</th><th>Status</th><th>Action</th></tr>
        {% for c in cont if cont[c].owner == session['email']%}
        <tr>
            <td>{{c}}</td><td>{{cont[c].name}}</td><td>{{cont[c].latestpoint|f}}</td><td>{{cont[c].leverage|f}}</td><td>{{cont[c].btc_multi|f}}</td>
            <td>{{cont[c].opendate}}</td><td>{{cont[c].settledate}}</td><td>{{cont[c].fullname}}</td><td>{{cont[c].region}}</td>
            <td>{{cont[c].sector}}</td><td>{{cont[c].status|f("C")}}</td>
            <td>{% if cont[c].status == 'O' %}<a href="{{ url_for('trade',c=c) }}"> Trade </a>{% elif cont[c].status == 'C' %}
                <a class="modalInput" href="#Settle"> Settle </a>{% elif cont[c].status == 'N' %}<a class="modalInput" rel="#edit_cont" href="#Edit"> Edit </a>{% endif %}</td>
        </tr>
        {% else %}
        <tr>None</tr>
        {% endfor %}
    </table>
    <div class="modal" id="edit_cont">
        <h3>Create a New Contract</h3>
        <div class="modal_wrap">        <br/>
    <form action="{{ url_for('contract') }}" method=post>
        <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
        <table>
            <tr><th>Code</th><td><input type=text name=code minlength="3" maxlength="6" required="required"></td>
                <th>Open Date</th><td><input type=date name=opendate min=1 max=366 ></td>
            <tr><th>Full Name</th><td><input type=text name=fullname></td>
            <th>Settle Date</th><td><input type=date name=settledate min=7 max=400 ></td></tr>
            <tr><th>Btc Multi</th><td><input type=number name=btc_multi min=0.000001 max=10000 required="required"></td>
                <th>Region</th><td><select name="region">
                    <option value="W" >World Wide</option>
                    <option value="N" >North America</option>
                    <option value="L" >Latin America / Carib.</option>
                    <option value="O" >Oceania / Australia</option>
                    <option value="M" >Middle East</option>
                    <option value="E" >Europe</option>
                    <option value="A" >Asia</option>
                    <option value="F" >Africa</option>
                </select></td>
            <tr><th>Leverage</th><td><input type=number name=leverage min=0.1 max=1 required="required"></td>
            <th>Sector</th><td><select name="sector">
                <option value="C" >Currency</option>
                <option value="I" >Stock Index</option>
                <option value="M" >Commodity</option>
                <option value="S" >Sports</option>
                <option value="P" >Politic</option>
                <option value="E" >Entertainment</option>
                <option value="O" >Others</option>
            </select></td></tr>
            <tr><th>Twitter ID</th><td><input type=text name=twitter_id></td></tr>
            <tr><th>Description</th><td colspan="3">
                <textarea name="description" rows="10" cols="60"></textarea></td></tr>
        </table>
        <input type=submit value=Save>
    </form>
    </div>
    </div>
</div>

<div class="grid_13 account_tab">
    <h4>Account Status</h4>
    <table class="ginfo grid_6 push_1 alpha"><tr><th>Trade Password</th><td><img src="{{url_for('static',filename='img/_i_Y.png')}}"></td><td><button class="modalInput" rel="#set_pass">Reset</button></td></tr>
        <tr><th>Email Validate</th><td><img src="{{url_for('static',filename='img/_i_' + g.u['email_v'] +'.png')}}"></td>
            <td>{% if g.u['email_v'] == 'N' %}<button class="modalInput" rel="#valid_mail">Validate</button>{% endif %}</td></tr>
        <tr><th>Capital Password</th><td><img src="{{url_for('static',filename='img/_i_' + g.u['password2'] +'.png')}}"></td><td><button class="modalInput" rel="#set_cpass">Reset</button></td></tr></table>
    <div class="grid_6 prefix_1 omega">
        <p>Trade Password: for login and trade</p>
        <p>Validate Email: for reset password if lost password</p>
        <p>Capital Password: for Bitcoin Withdraw</p>
    </div>
    <div class="clear"></div>
    <h4>Access Log</h4>
    <table>
        <tr><th>Timestamp</th><th>Action</th><th>IP Address</th><th>Approximate Location</th><th>Times</th></tr>
        {% for l in g.u['log'] %}
            <tr>
                <td>{{ l.timestamp }}</td><td>{{ l.action }}</td><td class="ip">{{ l.ip }}</td><td>...</td><td>{{ l.times }}</td>
            </tr>
        {% endfor %}
    </table>

    <div class="modal" id="set_pass">
    <h2>Reset Password</h2><br/>
        <form action="{{ url_for('account',t='P') }}" method=post>
            <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
            <table>
                <tr><th>Current password</th>
                <td><input type="password" name="opassword" value="" minlength="6"/></td></tr>
                <tr><th>New password</th>
                <td><input type="password" name="password" value="" minlength="6" /></td></tr>
                <tr><th>Confirm new Password</th>
                <td><input type="password" name="password2" value="" data-equals="password"/></td></tr>
            </table><br/><input type=submit value=" RESET ">
        </form><h3><span class="form_result"><img src="{{url_for('static',filename='img/loading.gif')}}" alt=""></span></h3>
    </div>

    <div class="modal" id="valid_mail">
    <h2>Send Validate Email Again</h2><br/><br/><table><tr><th>
        <h3><em>{{ session['email'] }}</em></h3><br/>
        <form action="{{ url_for('account',t='E') }}" method=post>
            <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
            <input type=submit value="Send me">
        </form></th></tr></table><h3><span class="form_result"><img src="{{url_for('static',filename='img/loading.gif')}}" alt=""></span></h3>
    </div>

    <div class="modal" id="set_cpass">
        <h2>Reset Capital Password</h2><br/>
        <form action="{{ url_for('account',t='C') }}" method=post>
            <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
            <table>
                <tr><th>Current password</th>
                    <td><input {% if g.u['password2']=='N' %}type="text" name="opassword" value="not set yet" readonly=readonly
                               {% else %} type=password name="opassword" value="" minlength="6"{% endif %}/></td></tr>
                <tr><th>New capital password</th>
                    <td><input type="password" name="password" value="" minlength="6" /></td></tr>
                <tr><th>Confirm new password</th>
                    <td><input type="password" name="password2" value="" data-equals="password"/></td></tr>
            </table><br/><input type=submit value=" RESET ">
        </form><h3><span class="form_result"><img src="{{url_for('static',filename='img/loading.gif')}}" alt=""></span></h3>
    </div>
</div>
<script type="text/javascript">showtab({{ tab }})</script>
{% endblock %}